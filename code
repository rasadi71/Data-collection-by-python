import cv2
import numpy as np
import time
import os

# --- INITIALIZATION ---
cap = cv2.VideoCapture(0)
if not cap.isOpened():
    print("Error: Could not open camera.")
    exit()

# Load the pre-trained Haar Cascade classifier for face detection
face_cascade = cv2.CascadeClassifier(cv2.data.haarcascades + 'haarcascade_frontalface_default.xml')

# Parameters
offset = 40  # Margin around the face bounding box

# Data collection settings
# IMPORTANT: Change 'Face_Raw_Variable' to a different folder name for a new subject/label.
folder = "Data/Face_Raw_Variable"
# Create the directory if it doesn't exist
os.makedirs(folder, exist_ok=True)
counter = 0

print(f"Collecting RAW data for: {folder}")
print("Press 's' to save an image and 'q' to quit.")

while True:
    success, img = cap.read()
    if not success:
        break

    # Convert to grayscale for face detection
    gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
    
    # Detect faces
    faces = face_cascade.detectMultiScale(gray, scaleFactor=1.1, minNeighbors=5, minSize=(100, 100))

    if len(faces) > 0:
        # Process the first detected face
        x, y, w, h = faces[0]

        # Draw a rectangle around the face on the main image
        cv2.rectangle(img, (x, y), (x + w, y + h), (255, 0, 0), 2)
        
        # Safely determine crop area with offset
        x1 = max(0, x - offset)
        y1 = max(0, y - offset)
        x2 = min(img.shape[1], x + w + offset)
        y2 = min(img.shape[0], y + h + offset)

        imgCrop = img[y1:y2, x1:x2]
        
        # --- REMOVED RESIZING/PADDING LOGIC ---
        # We will now use imgCrop directly.
        
        if imgCrop.shape[0] > 0 and imgCrop.shape[1] > 0:
            # Display the cropped image (will show its actual size)
            cv2.imshow("ImageCrop (Raw Size)", imgCrop)
            
            # Since we are not using imgWhite, we remove its display
            # cv2.imshow("ImageWhite", imgWhite) 

    # Display Main Image
    cv2.imshow("Image", img)
    key = cv2.waitKey(1)

    # Save image on 's' key press
    if key == ord('s'):
        if 'imgCrop' in locals() and imgCrop.shape[0] > 0 and imgCrop.shape[1] > 0:
            counter += 1
            # Save the raw cropped image directly
            cv2.imwrite(f'{folder}/Image_{counter:04d}_{imgCrop.shape[0]}x{imgCrop.shape[1]}.jpg', imgCrop)
            print(f'Saved {counter} images (Size: {imgCrop.shape[0]}x{imgCrop.shape[1]}) to {folder}')
        else:
            print("Face not detected or crop failed. Cannot save.")

    # Exit on 'q' key press
    if key == ord('q'):
        break

# --- CLEANUP ---
cap.release()
cv2.destroyAllWindows()
